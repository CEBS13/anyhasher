name: CI/CD Pipeline
run-name: "üõ†Ô∏è CI/CD: ${{ github.event.head_commit.message }} (${{ github.sha }})"
on:
  push: 
    branches:
      - blue-green-demo   #normally 'main'

jobs:
  ci:
    uses: ./.github/workflows/backend/build.yml

  deploy:
    needs: [ci]
    uses: ./.github/workflows/backend/deploy.yml
    with: 
      ref: ${{ github.sha }}      

  verify:
    needs: [deploy]
    uses: ./.github/workflows/backend/verify.yml
    with: 
      ref: ${{ github.sha }}
      backend_url: ${{ needs.deploy.outputs.backend_url }}
      frontend_url: ${{ needs.deploy.outputs.frontend_url }}
      
  promote:
    needs: [verify]
    id: promote
    uses: ./.github/workflows/frontend/promote.yml
    with: 
      ref: ${{ github.sha }}
      s3_bucket_hostname: ${{ needs.deploy.outputs.s3_bucket_hostname }}

  failure:
    needs: [ci, deploy, verify, promote]
    if: failure()
    uses: ./.github/workflows/backend/cleanup.yml
    with: 
      ref: ${{ github.sha }}
      env_name: Green
      reason: failure